{% extends "portal/base_portal.html" %}
{% block title %}Dashboard · Portal{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-6">Dashboard</h1>

<main class="flex-1">
  <div class="max-w-6xl mx-auto px-4 py-8 space-y-8">

    <div class="rounded-lg border border-blue-200 bg-blue-50 p-4 text-sm text-blue-800">
      <strong>LGPD:</strong> Este painel mostra apenas <em>indicadores agregados</em> (sem dados pessoais).
    </div>

    <!-- Cards principais (apenas ativos) -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl shadow-sm border p-4">
        <p class="text-xs text-gray-500">Pacientes na Fila (ativos)</p>
        <p class="mt-2 text-3xl font-semibold text-gray-900">{{ pacientes_na_fila|default:0 }}</p>
      </div>

      <div class="bg-white rounded-xl shadow-sm border p-4">
        <p class="text-xs text-gray-500">Especialidades na Fila (ativas)</p>
        <p class="mt-2 text-3xl font-semibold text-gray-900">{{ especialidades_na_fila|default:0 }}</p>
      </div>

      <div class="bg-white rounded-xl shadow-sm border p-4">
        <p class="text-xs text-gray-500">Procedimentos na Fila (ativos)</p>
        <p class="mt-2 text-3xl font-semibold text-gray-900">{{ procedimentos_na_fila|default:0 }}</p>
      </div>
    </section>

    <!-- Recortes -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl shadow-sm border p-4">
        <p class="text-sm font-medium text-gray-800">Eletivos</p>
        <p class="mt-2 text-2xl font-semibold text-blue-600">{{ count_eletivos|default:0 }}</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border p-4">
        <p class="text-sm font-medium text-gray-800">Oncológicos</p>
        <p class="mt-2 text-2xl font-semibold text-amber-600">{{ count_oncologicos|default:0 }}</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border p-4">
        <p class="text-sm font-medium text-gray-800">Judicializados</p>
        <p class="mt-2 text-2xl font-semibold text-red-600">{{ count_judicializados|default:0 }}</p>
      </div>
    </section>

    <!-- Linha 1: Pizza (ativos) + Barras (entradas criadas) -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border p-4">
        <h2 class="text-sm font-semibold mb-2">Distribuição por Especialidade (ativos)</h2>
        <div class="h-[260px]">
          <canvas id="pieChart" aria-label="Distribuição por Especialidade"></canvas>
        </div>
        {% if not labels %}
          <p class="mt-3 text-xs text-gray-500">Sem dados para exibir.</p>
        {% endif %}
      </div>

      <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border p-4">
        <h2 class="text-sm font-semibold mb-2">Entradas criadas (últimos 3 meses)</h2>
        <div class="h-[260px]">
          <canvas id="barChart" aria-label="Entradas criadas (3 meses)"></canvas>
        </div>
        {% if not labels_bar %}
          <p class="mt-3 text-xs text-gray-500">Sem dados recentes para exibir.</p>
        {% endif %}
      </div>
    </section>

    <!-- Linha 2: Top-10 (ativos) -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl shadow-sm border p-4">
        <h2 class="text-sm font-semibold mb-2">Top 10 – Mais Pacientes na Fila (ativos)</h2>
        <div class="h-[320px]">
          <canvas id="procCountChart" aria-label="Top 10 procedimentos com mais pacientes"></canvas>
        </div>
        {% if not labels_proc_count %}
          <p class="mt-3 text-xs text-gray-500">Sem dados para exibir.</p>
        {% endif %}
      </div>

      <div class="bg-white rounded-xl shadow-sm border p-4">
        <h2 class="text-sm font-semibold mb-2">Top 10 – Maior Tempo de Espera (dias, ativos)</h2>
        <div class="h-[320px]">
          <canvas id="procWaitChart" aria-label="Top 10 procedimentos por tempo de espera"></canvas>
        </div>
        {% if not labels_proc_wait %}
          <p class="mt-3 text-xs text-gray-500">Sem dados para exibir.</p>
        {% endif %}
      </div>
    </section>
  </div>
</main>

<!-- Dados: embed com json_script -->
{{ labels|json_script:"labels_json" }}
{{ data|json_script:"data_json" }}
{{ percentages|json_script:"percentages_json" }}
{{ labels_bar|json_script:"labels_bar_json" }}
{{ data_bar|json_script:"data_bar_json" }}
{{ labels_proc_count|json_script:"labels_proc_count_json" }}
{{ data_proc_count|json_script:"data_proc_count_json" }}
{{ labels_proc_wait|json_script:"labels_proc_wait_json" }}
{{ data_proc_wait|json_script:"data_proc_wait_json" }}
<script>
  // 1) Carrega Chart.js se ainda não estiver presente
  (function ensureChartJS(cb){
    if (window.Chart) return cb();
    var s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
    s.onload = cb;
    s.onerror = function(){ console.error("Chart.js não pôde ser carregado."); };
    document.head.appendChild(s);
  })(initDashboardCharts);

  // 2) Utilitário seguro p/ ler <script type="application/json" id="...">
  function getJSON(id, fallback) {
    var el = document.getElementById(id);
    if (!el) return fallback;
    try {
      var txt = (el.textContent || "").trim();
      if (!txt) return fallback;
      var parsed = JSON.parse(txt);
      return (parsed === null ? fallback : parsed);
    } catch (e) { return fallback; }
  }

  function initDashboardCharts(){
    const COLORS = (window.indicadoresColors && window.indicadoresColors.length)
      ? window.indicadoresColors
      : ["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#06B6D4","#84CC16","#F472B6","#F97316","#22C55E"];

    const labels         = getJSON('labels_json', []);
    const data           = getJSON('data_json', []);
    const percentages    = getJSON('percentages_json', []);
    const labelsBar      = getJSON('labels_bar_json', []);
    const dataBar        = getJSON('data_bar_json', []);
    const labelsProcCnt  = getJSON('labels_proc_count_json', []);
    const dataProcCnt    = getJSON('data_proc_count_json', []);
    const labelsProcWait = getJSON('labels_proc_wait_json', []);
    const dataProcWait   = getJSON('data_proc_wait_json', []);

    const commonOptions = {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#374151', font: { size: 12 } } },
        tooltip: {
          backgroundColor: '#111827', titleColor: '#F9FAFB', bodyColor: '#D1D5DB',
          borderColor: '#6B7280', borderWidth: 1
        }
      },
      scales: {
        x: { ticks: { color: '#6B7280' }, grid: { color: '#E5E7EB' } },
        y: { ticks: { color: '#6B7280' }, grid: { color: '#E5E7EB' } },
      }
    };

    // Pie
    if (labels.length && data.length) {
      const el = document.getElementById('pieChart');
      if (el) new Chart(el, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: labels.map((_, i) => COLORS[i % COLORS.length]),
            borderWidth: 1, borderColor: '#ffffff', hoverOffset: 8
          }]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              ...commonOptions.plugins.tooltip,
              callbacks: {
                label: (ctx) => {
                  const pct = percentages[ctx.dataIndex] ?? 0;
                  return `${ctx.label}: ${ctx.parsed} (${pct}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Barras (entradas criadas)
    if (labelsBar.length && dataBar.length) {
      const el = document.getElementById('barChart');
      if (el) new Chart(el, {
        type: 'bar',
        data: {
          labels: labelsBar,
          datasets: [{ label: 'Entradas criadas', data: dataBar, backgroundColor: '#3B82F6', borderRadius: 6 }]
        },
        options: {
          ...commonOptions,
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0, color: '#6B7280' }, grid: { color: '#E5E7EB' } },
            x: { ticks: { color: '#6B7280' }, grid: { display: false } }
          }
        }
      });
    }

    // Top-10 por quantidade (ativos)
    if (labelsProcCnt.length && dataProcCnt.length) {
      const el = document.getElementById('procCountChart');
      if (el) new Chart(el, {
        type: 'bar',
        data: {
          labels: labelsProcCnt,
          datasets: [{ label: 'Pacientes (ativos)', data: dataProcCnt, backgroundColor: '#10B981', borderRadius: 6 }]
        },
        options: {
          ...commonOptions,
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0, color: '#6B7280' }, grid: { color: '#E5E7EB' } },
            y: { ticks: { color: '#6B7280' }, grid: { display: false } }
          }
        }
      });
    }

    // Top-10 por espera (ativos)
    if (labelsProcWait.length && dataProcWait.length) {
      const el = document.getElementById('procWaitChart');
      if (el) new Chart(el, {
        type: 'bar',
        data: {
          labels: labelsProcWait,
          datasets: [{ label: 'Dias de espera (ativos)', data: dataProcWait, backgroundColor: '#F59E0B', borderRadius: 6 }]
        },
        options: {
          ...commonOptions,
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0, color: '#6B7280' }, grid: { color: '#E5E7EB' } },
            y: { ticks: { color: '#6B7280' }, grid: { display: false } }
          }
        }
      });
    }
  }
</script>

{% endblock %}
